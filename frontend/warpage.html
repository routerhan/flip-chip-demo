<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGA-AI Warpage Prediction</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { display: flex; max-width: 1400px; margin: auto; padding: 20px; gap: 20px; }
        .sidebar { flex: 0 0 400px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .main-content { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tabs { display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 16px; }
        .tab-button.active { border-bottom: 2px solid #0d6efd; font-weight: bold; color: #0d6efd; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 100px; }
        button { width: 100%; padding: 10px; background-color: #0d6efd; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #0b5ed7; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #plot { width: 100%; height: 600px; }
        #results h3 { margin-top: 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>BGA-AI 翹曲預測</h2>
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('convex')">翹曲預測(凸)</button>
            <button class="tab-button" onclick="switchTab('concave')">翹曲預測(凹)</button>
        </div>

        <form id="prediction-form">
            <div id="tool-height-group" class="form-group">
                <label for="tool_height">Tool 高度 (mm)</label>
                <input type="number" id="tool_height" value="0" step="0.001">
            </div>
            <div class="form-group">
                <label for="magnet">磁鐵數量</label>
                <input type="number" id="magnet" value="10" min="10" max="40">
            </div>
            <div class="form-group">
                <label for="jig">Jig 厚度 (mm)</label>
                <select id="jig">
                    <option value="0.5">0.5</option>
                    <option value="1.0" selected>1.0</option>
                    <option value="1.5">1.5</option>
                    <option value="2.0">2.0</option>
                </select>
            </div>
            <div class="form-group">
                <label for="copper">Copper Ratio (%)</label>
                <select id="copper">
                    <option value="100">100</option>
                    <option value="90">90</option>
                    <option value="85">85</option>
                    <option value="80">80</option>
                    <option value="75">75</option>
                    <option value="70">70</option>
                </select>
            </div>
            <div class="form-group">
                <label for="b1">Jig 中心矩形孔 B1 (mm)</label>
                <input type="number" id="b1" value="40" min="40" max="60">
            </div>
            <div class="form-group">
                <label for="w1">Jig 中心矩形孔 W1 (mm)</label>
                <input type="number" id="w1" value="47" min="47" max="67">
            </div>
            <div class="form-group">
                <label for="substrate">Substrate 規格 (mm)</label>
                <select id="substrate">
                    <option value="55">55x55</option>
                    <option value="65">65x65</option>
                    <option value="75">75x75</option>
                    <option value="85">85x85</option>
                    <option value="105">105x105</option>
                </select>
            </div>

            <div class="form-group">
                <label for="sbthk_preset">Substrate 層數設定 (SBthk)</label>
                <select id="sbthk_preset" onchange="applyPreset('sbthk')">
                    <option value="">手動輸入</option>
                    <option value="default1">預設值 1</option>
                </select>
                <textarea id="sbthk_vals" placeholder="請輸入 33 個以逗號分隔的層厚數值 (mm)"></textarea>
            </div>

            <div class="form-group">
                <label for="material_preset">Substrate 材料參數</label>
                <select id="material_preset" onchange="applyPreset('material')">
                    <option value="">手動輸入</option>
                    <option value="pp">PP</option>
                    <option value="pi">PI</option>
                </select>
                <textarea id="material_vals" placeholder="請輸入 7 個以逗號分隔的材料參數"></textarea>
            </div>

            <button type="submit" id="submit-btn">開始預測</button>
        </form>
    </div>
    <div class="main-content">
        <div id="results">
            <h3>預測結果</h3>
            <div id="result-summary">請先輸入參數並點擊「開始預測」。</div>
            <div class="spinner" id="spinner"></div>
        </div>
        <div id="plot"></div>
    </div>
</div>

<script>
    let currentTab = 'convex';

    const presets = {
        sbthk: {
            default1: [
                0.015, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03,
                0.015, 0.03, 0.015, 0.03, 0.018, 1.24, 0.018, 0.03, 0.015, 0.03, 0.015,
                0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.018
            ]
        },
        material: {
            pp: [14900, 0.43, 500, 0.43, 1.10e-5, 3.70e-5, 130],
            pi: [3000, 0.34, 2500, 0.34, 3.5e-5, 5.0e-5, 360]
        }
    };

    function applyPreset(type) {
        const presetKey = document.getElementById(`${type}_preset`).value;
        const targetTextarea = document.getElementById(`${type}_vals`);
        if (presetKey && presets[type][presetKey]) {
            targetTextarea.value = presets[type][presetKey].join(', ');
        }
    }

    function switchTab(tabName) {
        currentTab = tabName;
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');
        
        const toolHeightGroup = document.getElementById('tool-height-group');
        if (tabName === 'convex') {
            toolHeightGroup.style.display = 'block';
        } else {
            toolHeightGroup.style.display = 'none';
        }
    }

    document.getElementById('prediction-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');
        const resultSummary = document.getElementById('result-summary');
        
        submitBtn.disabled = true;
        spinner.style.display = 'block';
        resultSummary.innerHTML = '正在計算中，請稍候...';
        Plotly.purge('plot');

        try {
            const sbthk_vals = document.getElementById('sbthk_vals').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const material_vals = document.getElementById('material_vals').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));

            if (sbthk_vals.length !== 33) {
                throw new Error(`Substrate 層數必須是 33 個數值，您輸入了 ${sbthk_vals.length} 個。`);
            }
            if (material_vals.length !== 7) {
                throw new Error(`材料參數必須是 7 個數值，您輸入了 ${material_vals.length} 個。`);
            }

            let payload = {
                magnet: parseInt(document.getElementById('magnet').value),
                jig: parseFloat(document.getElementById('jig').value),
                copper: parseInt(document.getElementById('copper').value),
                b1: parseInt(document.getElementById('b1').value),
                w1: parseInt(document.getElementById('w1').value),
                substrate: parseInt(document.getElementById('substrate').value),
                sbthk_vals: sbthk_vals,
                material_vals: material_vals,
            };

            if (currentTab === 'convex') {
                payload.tool_height = parseFloat(document.getElementById('tool_height').value);
            }

            const response = await fetch(`http://127.0.0.1:8000/predict/${currentTab}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'accept': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API 錯誤: ${errorData.detail || response.statusText}`);
            }

            const data = await response.json();
            
            // 顯示結果
            let summaryHtml = `<h4>輸入參數摘要</h4><ul>`;
            for (const [key, value] of Object.entries(data.input_summary)) {
                summaryHtml += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            summaryHtml += `</ul><h4>預測翹曲量: <span style="color: #0d6efd;">${data.warpage_um.toFixed(2)} μm</span></h4>`;
            resultSummary.innerHTML = summaryHtml;

            // 繪製 3D 圖
            const plotData = [{
                x: data.plot_data.x,
                y: data.plot_data.y,
                z: data.plot_data.z,
                type: 'surface',
                colorscale: 'Viridis'
            }];
            const layout = {
                title: '3D Warpage Surface Plot',
                scene: {
                    xaxis: { title: 'X (mm)' },
                    yaxis: { title: 'Y (mm)' },
                    zaxis: { title: 'Z (mm)' }
                },
                margin: { l: 0, r: 0, b: 0, t: 40 }
            };
            Plotly.newPlot('plot', plotData, layout);

        } catch (error) {
            resultSummary.innerHTML = `<p style="color: red;">錯誤: ${error.message}</p>`;
        } finally {
            submitBtn.disabled = false;
            spinner.style.display = 'none';
        }
    });

    // 初始化時，自動填入預設值
    document.addEventListener('DOMContentLoaded', () => {
        applyPreset('sbthk');
        applyPreset('material');
    });

</script>

</body>
</html>