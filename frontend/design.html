<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGA-AI Parameter Design</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; }
        .container { display: flex; max-width: 1400px; margin: auto; padding: 20px; gap: 20px; }
        .sidebar { flex: 0 0 400px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .main-content { flex: 1; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tabs { display: flex; border-bottom: 1px solid #dee2e6; margin-bottom: 20px; }
        .tab-button { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 16px; }
        .tab-button.active { border-bottom: 2px solid #0d6efd; font-weight: bold; color: #0d6efd; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 100px; }
        button { width: 100%; padding: 10px; background-color: #0d6efd; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #0b5ed7; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #results h3 { margin-top: 0; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <div class="sidebar">
        <h2>BGA-AI 參數設計</h2>
        <div class="tabs">
            <button class="tab-button active" data-view="convex" onclick="switchView('convex')">AI 設計(凸)</button>
            <button class="tab-button" data-view="concave" onclick="switchView('concave')">AI 設計(凹)</button>
        </div>
        <form id="design-form">
            <div class="form-group">
                <label for="target_warpage">目標翹曲值 (μm)</label>
                <input type="number" id="target_warpage" value="25" step="0.1">
            </div>
            <div class="form-group">
                <label for="design_substrate">Substrate 規格 (mm)</label>
                <select id="design_substrate">
                    <option value="55">55x55</option>
                    <option value="65">65x65</option>
                    <option value="75">75x75</option>
                    <option value="85">85x85</option>
                    <option value="105">105x105</option>
                </select>
            </div>
            <div class="form-group">
                <label for="design_copper">Copper Ratio (%)</label>
                <select id="design_copper">
                    <option value="100">100</option>
                    <option value="90">90</option>
                    <option value="85">85</option>
                    <option value="80">80</option>
                    <option value="75">75</option>
                    <option value="70">70</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="sbthk_preset">Substrate 層數設定 (SBthk)</label>
                <select id="sbthk_preset" onchange="applyPreset('sbthk')">
                    <option value="">手動輸入</option>
                    <option value="default1">預設值 1</option>
                </select>
                <textarea id="sbthk_vals" placeholder="請輸入 33 個以逗號分隔的層厚數值 (mm)"></textarea>
            </div>

            <div class="form-group">
                <label for="material_preset">Substrate 材料參數</label>
                <select id="material_preset" onchange="applyPreset('material')">
                    <option value="">手動輸入</option>
                    <option value="pp">PP</option>
                    <option value="pi">PI</option>
                </select>
                <textarea id="material_vals" placeholder="請輸入 7 個以逗號分隔的材料參數"></textarea>
            </div>

            <button type="submit" id="design-submit-btn">開始設計</button>
        </form>
    </div>
    <div class="main-content">
        <div id="results">
            <h3>設計結果</h3>
            <div id="result-summary">請設定參數並點擊「開始設計」。</div>
            <div class="spinner" id="spinner"></div>
        </div>
        <!-- 3D Plot is not used in design mode, so it's removed -->
    </div>
</div>

<script>
    let currentView = 'convex';
    let pollingInterval = null;

    const presets = {
        sbthk: {
            default1: [
                0.015, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03,
                0.015, 0.03, 0.015, 0.03, 0.018, 1.24, 0.018, 0.03, 0.015, 0.03, 0.015,
                0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.03, 0.015, 0.018
            ]
        },
        material: {
            pp: [14900, 0.43, 500, 0.43, 1.10e-5, 3.70e-5, 130],
            pi: [3000, 0.34, 2500, 0.34, 3.5e-5, 5.0e-5, 360]
        }
    };

    function applyPreset(type) {
        const presetKey = document.getElementById(`${type}_preset`).value;
        const targetTextarea = document.getElementById(`${type}_vals`);
        if (presetKey && presets[type][presetKey]) {
            targetTextarea.value = presets[type][presetKey].join(', ');
        }
    }

    function switchView(viewName) {
        currentView = viewName;
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-button[data-view="${viewName}"]`).classList.add('active');
    }

    async function handleDesignSubmit(event) {
        event.preventDefault();

        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }

        const submitBtn = document.getElementById('design-submit-btn');
        const spinner = document.getElementById('spinner');
        const resultSummary = document.getElementById('result-summary');

        submitBtn.disabled = true;
        spinner.style.display = 'block';
        resultSummary.innerHTML = 'AI 設計任務已提交，正在啟動中...';

        try {
            const sbthk_vals = document.getElementById('sbthk_vals').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const material_vals = document.getElementById('material_vals').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));

            if (sbthk_vals.length !== 33) throw new Error(`Substrate 層數必須是 33 個數值，您輸入了 ${sbthk_vals.length} 個。`);
            if (material_vals.length !== 7) throw new Error(`材料參數必須是 7 個數值，您輸入了 ${material_vals.length} 個。`);

            const payload = {
                target_warpage_um: parseFloat(document.getElementById('target_warpage').value),
                substrate: parseInt(document.getElementById('design_substrate').value),
                copper: parseInt(document.getElementById('design_copper').value),
                sbthk_vals: sbthk_vals,
                material_vals: material_vals,
            };

            const response = await fetch(`http://127.0.0.1:8001/design/${currentView}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'accept': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API 錯誤: ${errorData.detail || response.statusText}`);
            }

            const data = await response.json();
            startPolling(data.task_id);

        } catch (error) {
            resultSummary.innerHTML = `<p style="color: red;">錯誤: ${error.message}</p>`;
            submitBtn.disabled = false;
            spinner.style.display = 'none';
        }
    }

    function startPolling(taskId) {
        const resultSummary = document.getElementById('result-summary');
        resultSummary.innerHTML = 'AI 正在搜尋最佳參數組合，請稍候... (這可能需要數分鐘)';

        pollingInterval = setInterval(async () => {
            try {
                const response = await fetch(`http://127.0.0.1:8001/design/status/${taskId}`);
                if (!response.ok) throw new Error(`狀態查詢失敗: ${response.statusText}`);
                
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    displayDesignResults(data.result);
                    document.getElementById('design-submit-btn').disabled = false;
                    document.getElementById('spinner').style.display = 'none';
                } else if (data.status === 'failed') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    throw new Error(data.error || 'AI 設計任務執行失敗。');
                }
            } catch (error) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                resultSummary.innerHTML = `<p style="color: red;">錯誤: ${error.message}</p>`;
                document.getElementById('design-submit-btn').disabled = false;
                document.getElementById('spinner').style.display = 'none';
            }
        }, 3000); // 每 3 秒查詢一次
    }

    function displayDesignResults(result) {
        const resultSummary = document.getElementById('result-summary');
        const params = result.best_parameters;
        let summaryHtml = `<h4>AI 設計完成！</h4>
                           <p>最接近目標的翹曲量為: <span style="color: #0d6efd;">${result.achieved_warpage_um.toFixed(2)} μm</span></p>
                           <h4>最佳參數組合:</h4>
                           <ul>`;
        if (params.tool_height !== null && params.tool_height !== undefined) {
            summaryHtml += `<li><strong>Tool 高度:</strong> ${params.tool_height.toFixed(3)} mm</li>`;
        }
        summaryHtml += `       <li><strong>磁鐵數量:</strong> ${params.magnet}</li>
                               <li><strong>Jig 厚度:</strong> ${params.jig.toFixed(1)} mm</li>
                               <li><strong>Jig 中心矩形孔:</strong> ${params.b1}x${params.w1} mm²</li>
                           </ul>`;
        resultSummary.innerHTML = summaryHtml;
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('design-form').addEventListener('submit', handleDesignSubmit);
        applyPreset('sbthk');
        applyPreset('material');
    });
</script>

</body>
</html>